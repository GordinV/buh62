Set step on
Create cursor curKey (versia m)
Append blank
Replace versia with 'EELARVE' in curKey
Create cursor v_account (admin int default 1)
Append blank
*!*	gnhandle = sqlconnect ('narva','jelena','208')
*!*	&&,'zinaida','159')
*!*	gversia = 'MSSQL'
*!*	grekv = 2
cdata = 'c:\buh50\dbase\buhdata5.dbc'
gnHandle = 1
gversia = 'VFP'
Open data (cdata)
grekv = 1
Local lError
If v_account.admin < 1
	Return .t.
Endif
CREATE cursor scrBilanss (nimetus c(254), rea c(20), konto c(20))
insert into scrBilanss (nimetus, rea, konto) values ('ДЕНЬГИ И БАНКОВСКИЕ СЧЕТА','1','' )
insert into scrBilanss (nimetus, rea, konto) values ('Деньги в кассе','1.1','')
insert into scrBilanss (nimetus, rea, konto) values ('Деньги на счетах EEK','1.2','')
insert into scrBilanss (nimetus, rea, konto) values ('Валютные счета','1.2','')
insert into scrBilanss (nimetus, rea, konto) values ('АКЦИИ И ПРОЧИЕ ЦЕННЫЕ БУМАГИ','2','')
insert into scrBilanss (nimetus, rea, konto) values ('ЗАДОЛЖЕННОСТЬ ПОКУПАТЕЛЕЙ','3','')
insert into scrBilanss (nimetus, rea, konto) values ('Неоплаченные покупателями счета','3.1','')
insert into scrBilanss (nimetus, rea, konto) values ('Векселя покупателей','3.2','')
insert into scrBilanss (nimetus, rea, konto) values ('Счета, поступление сумм по которым невероятно (минус)','3.3','')
insert into scrBilanss (nimetus, rea, konto) values ('РАЗЛИЧНАЯ ДЕБИТОРСКАЯ ЗАДОЛЖЕННОСТЬ','4','')
insert into scrBilanss (nimetus, rea, konto) values ('Требования дочерних предприятий','4.1','')
insert into scrBilanss (nimetus, rea, konto) values ('Требования связанных ','4.2','')
insert into scrBilanss (nimetus, rea, konto) values ('Расчеты с акционерами','4.3','')
insert into scrBilanss (nimetus, rea, konto) values ('Прочие краткосрочные задолженности','5','')
insert into scrBilanss (nimetus, rea, konto) values ('Интрессы','5.1','')
insert into scrBilanss (nimetus, rea, konto) values ('Дивиденты','5.2','')
insert into scrBilanss (nimetus, rea, konto) values ('Прочие просроченные поступления','5.3','')
insert into scrBilanss (nimetus, rea, konto) values ('ПРЕДОПЛАЧЕННЫЕ РАСХОДЫ БУДУЩИХ ПЕРИОДОВ','6','')
insert into scrBilanss (nimetus, rea, konto) values ('Предоплаты налогов и возврат налогов','6.1','')
insert into scrBilanss (nimetus, rea, konto) values ('Прочие предоплаченные расходы будущих периодов','6.2','')
insert into scrBilanss (nimetus, rea, konto) values ('3АПАСЫ','7','')
insert into scrBilanss (nimetus, rea, konto) values ('Сырье и материал','7.1','')
insert into scrBilanss (nimetus, rea, konto) values ('Незавершенная продукция','7.2','')
insert into scrBilanss (nimetus, rea, konto) values ('Готовая продукция','7.3','')
insert into scrBilanss (nimetus, rea, konto) values ('Товары, приобретенные для продажи','7.4','')
insert into scrBilanss (nimetus, rea, konto) values ('Предоплаты поставщикам','7.5','')
insert into scrBilanss (nimetus, rea, konto) values ('ДОЛГОСРОЧНЫЕ ФИНАНСОВЫЕ ИНВЕСТИЦИИ','8','')
insert into scrBilanss (nimetus, rea, konto) values ('Акции и вклады в дочерние предприятия','8.1','')
insert into scrBilanss (nimetus, rea, konto) values ('Прочие акции, вклады и заемные обязательства','8.2','')
insert into scrBilanss (nimetus, rea, konto) values ('Долгосрочные неоплаченные покупателями счета','8.3','')
insert into scrBilanss (nimetus, rea, konto) values ('МАТЕРИАЛЬНОЕ ОСНОВНОЕ ИМУЩЕСТВО','9','')
insert into scrBilanss (nimetus, rea, konto) values ('Земля и сооружения (по стоимости приобретения)','9.1','')
insert into scrBilanss (nimetus, rea, konto) values ('Машины и оборудования (по стоимости приобретения)','9.2','')
insert into scrBilanss (nimetus, rea, konto) values ('Прочий инвентарь, орудия труда, устройства и прочее (по цене приобретерия)','9.3','')
insert into scrBilanss (nimetus, rea, konto) values ('Аккумулированный износ основного имущества (минус)','9.3','')
insert into scrBilanss (nimetus, rea, konto) values ('Незавершенное строительство','9.4', '')
insert into scrBilanss (nimetus, rea, konto) values ('Предоплаты за материальное имущество','9.5', '')
insert into scrBilanss (nimetus, rea, konto) values ('НЕМАТЕРИАЛЬНОЕ ОСНОВНОЕ ИМУЩЕСТВО','10', '')
insert into scrBilanss (nimetus, rea, konto) values ('Лицензии','10.1', '')
insert into scrBilanss (nimetus, rea, konto) values ('','10.2', '')
insert into scrBilanss (nimetus, rea, konto) values ('Купленные патенты и торговые марки','10.3', '')
insert into scrBilanss (nimetus, rea, konto) values ('КРАТКОСРОЧНЫЕ ОБЯЗАТЕЛЬСТВА','11', '')
insert into scrBilanss (nimetus, rea, konto) values ('Краткосрочные займы от кредитных учреждений','11.1', '')
insert into scrBilanss (nimetus, rea, konto) values (' ','11.2', '')
insert into scrBilanss (nimetus, rea, konto) values ('Выплаты за следующий период по долг.банк. ссудам','11.3', '')
insert into scrBilanss (nimetus, rea, konto) values ('Неоплаченные счета поставщикам','11.5', '')
insert into scrBilanss (nimetus, rea, konto) values ('Muud lьhiajalised kohustused','11.6', '')
insert into scrBilanss (nimetus, rea, konto) values ('Предоплаты','12', '')
insert into scrBilanss (nimetus, rea, konto) values ('Предоплаты налогов','13', '')
insert into scrBilanss (nimetus, rea, konto) values ('Социальный налог','13.1', '')
insert into scrBilanss (nimetus, rea, konto) values ('Подоходный налог','13.2', '')
insert into scrBilanss (nimetus, rea, konto) values ('Страхование от безработицы','13.4', '')
insert into scrBilanss (nimetus, rea, konto) values ('Налог с оборота','13.5', '')
insert into scrBilanss (nimetus, rea, konto) values ('Прочее','13.6', '')
insert into scrBilanss (nimetus, rea, konto) values ('ОТСРОЧЕННЫЕ ЗАДОЛЖЕННОСТИ (расх.неопл.в отч.периоде)','14', '')
insert into scrBilanss (nimetus, rea, konto) values ('Задолженность работополучателями','14.2', '')
insert into scrBilanss (nimetus, rea, konto) values ('ДОЛГОСРОЧНЫЕ ОБЯЗАТЕЛЬСТВА','15', '')
insert into scrBilanss (nimetus, rea, konto) values ('Банковские ссуды','15.1', '')
insert into scrBilanss (nimetus, rea, konto) values ('Лизинг','15.2', '')
insert into scrBilanss (nimetus, rea, konto) values ('Прочие долгосрочные обязательства','15.6', '')
insert into scrBilanss (nimetus, rea, konto) values ('СОБСТВЕННЫЙ КАПИТАЛ','16', '')
insert into scrBilanss (nimetus, rea, konto) values ('АКЦИОНЕРНЫЙ КАПИТАЛ ПО НОМИНАЛЬНОЙ СТОИМОСТИ','17', '')
insert into scrBilanss (nimetus, rea, konto) values ('Величина акционерного капитала, указанного в уставе','17.1', '')
insert into scrBilanss (nimetus, rea, konto) values ('Количество выпущенных преимущественных акций','17.2', '')
insert into scrBilanss (nimetus, rea, konto) values ('Количество выпущенных простых акций','17.3', '')
insert into scrBilanss (nimetus, rea, konto) values ('АЖИО (превышение номинальной стоимости)','17.4', '')
insert into scrBilanss (nimetus, rea, konto) values ('ПОДАРЕННЫЙ КАПИТАЛ','18', '')
insert into scrBilanss (nimetus, rea, konto) values ('РЕЗЕРВ ПЕРЕОЦЕНКИ','19', '')
insert into scrBilanss (nimetus, rea, konto) values ('РЕЗЕРВЫ','20', '')
insert into scrBilanss (nimetus, rea, konto) values ('Обязательный резервный капитал','20.1', '')
insert into scrBilanss (nimetus, rea, konto) values ('Прочие резервы','20.2', '')
insert into scrBilanss (nimetus, rea, konto) values (' в том числе Инвестиционный фонд','20.3', '')
insert into scrBilanss (nimetus, rea, konto) values ('НЕРАСПРЕДЕЛЕННАЯ ПРИБЫЛЬ ПРЕДЫДУЩИХ ПЕРИОДОВ','21', '')
insert into scrBilanss (nimetus, rea, konto) values ('ПРИБЫЛЬ (-УБЫТОК) ОТЧЕТНОГО ГОДА','22', '')
insert into scrBilanss (nimetus, rea, konto) values ('ТРЕЗОРНЫЕ АКЦИИ (минус)','23', '')
If !used ('key')
	Use key in 0
Endif
Select key
lnFields = afields (aObjekt)
Create cursor qryKey from array aObjekt
Select qryKey
Append from dbf ('key')
Use in key
=secure('OFF')


Do case
	Case gversia = 'VFP'
		Select qryKey
		Scan for mline(qryKey.connect,1) = 'FOX'
			lcdata = mline(qryKey.vfp,1)
			If file (lcdata)
				Open data (lcdata)
				lcdefault = sys(5)+sys(2003)
				Set DEFAULT TO justpath (lcdata)
				lError =  _alter_vfp()
				Close data
				Set default to (lcdefault)
			Endif
		Endscan
		Use in qryKey
	Case gversia = 'MSSQL'
		=sqlexec (gnhandle,'begin transaction')
		lError = _alter_mssql ()
		If vartype (lError ) = 'N'
			lError = iif( lError = 1,.t.,.f.)
		Endif
		If lError = .f.
			=sqlexec (gnhandle,'rollback')
		Else
			=sqlexec (gnhandle,'commit')
		Endif
Endcase

*!*	If lError = .f.
*!*		Messagebox ('Viga')
*!*	Endif
If gversia <> 'VFP'
	=sqldisconnect (gnhandle)
Endif
Return lError

Function _alter_vfp
&& выборка имеющихся рекв.
select id from rekv into cursor qry_Rekv
&& выборка имеющихся строк баланса
SELECT Library.kood, Library.nimetus, Library.library, Library.id,  Library.rekvid ;
 FROM Library WHERE Library.library LIKE 'BILANSS%' into cursor qry_bilanss

select qry_rekv
scan
	select scrBilanss
	scan
		select qry_bilanss
		locate for alltrim(kood) = alltrim(qry_bilanss.kood) and;
			alltrim(upper(nimetus)) = alltrim(upper(qry_bilanss.nimetus))
		if !found ()
			lcString = " insert into library (rekvid, kood, nimetus, library 0 values ("+;
				str (qry_rekv.id)+",'"+ ltrim(rtrim(scrBilanss.kood))+"','"+;
				ltrim(rtrim(scrBilanss.nimetus))+"','"+;
				"BILANSS"+LTRIM(RTRIM(scrBilanss.rea))+"')"
			&lcString
		endif 
	endscan
endscan
use in qry_rekv
use in qry_bilanss
if used ('library')
	use in library
endif
	Return

Function setpropview
	lnViews = adbobject (laView,'VIEW')
	For i = 1 to lnViews
		lError = dbsetprop(laView(i),'View','FetchAsNeeded',.t.)
	Endfor
	Return


Function _alter_mssql
	cString = "sp_help "
	lError = sqlexec (gnhandle,cString)
	If lError > 0
		If used ('sqlresult')
			Select sqlresult
			Locate for upper(name) = 'CURTOOD' and object_type = 'view'
			If !found ()
				cString = 'create view curtood as '+;
					'SELECT teenused.id, teenused.asutusid, left(ltrim(rtrim(asutus.nimetus))+space(1)+ltrim(rtrim(asutus.omvorm)),254) as asutus,'+;
					'asutus.regkood, teenused.rekvid, teenused.kpv,'+;
					'teenused.isikId, teenused.nomid, isikud.regkood AS isikukood, isikud.nimetus AS isik, nomenklatuur.kood, '+;
					'nomenklatuur.nimetus AS teenus, nomenklatuur.uhik, teenused.tundA, teenused.tundL, teenused.minA, teenused.minL,'+;
					'teenused.hind, teenused.kogus, teenused.kokku, teenused.arvid '+;
					'FROM  dbo.teenused INNER JOIN dbo.asutus ON teenused.asutusid = dbo.asutus.id '+;
					'INNER JOIN dbo.asutus isikud ON teenused.isikId = isikud.id '+;
					'INNER JOIN dbo.nomenklatuur ON teenused.nomid = dbo.nomenklatuur.id '

				lError = sqlexec(gnhandle, cString)
				If lError < 0
					Return .f.
				Endif


				cString = 'GRANT  SELECT  ON curtood  TO dbkasutaja'
				lError = sqlexec(gnhandle, cString)
				cString = 'GRANT  SELECT   ON curTood  TO dbpeakasutaja'
				lError = sqlexec(gnhandle, cString)
				lError = iif(lError > 0,.t.,.f.)
			Endif
		Endif
	Endif
	If used ('curKey') and 'EELARVE' $ curKey.versia
		cString = "SELECT id,kood from library where library = 'KONTOD' "
		lError = sqlexec (gnhandle,cString,'qryKnt')
		If lError < 0 or !used ('qryKnt')
			Return .f.
		Endif
&&		lError = sqlsetprop(gnhandle,'BatchMode',.f.)
		Select qryKnt
		Locate for kood = '1115'
		If !found ()
			cString = "insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1115','Elumajade osad (korterid)','KONTOD',"+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1117'
		If !found ()
			cString = "insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1117','Pikaajaliselt renditud maarajatised ja hooned – kapitalirent','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1240'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1240','Pikaajalised nouded asutustele','KONTOD', "+str(grekv)+")"
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1290'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1290','Finantspхhivarade ettemaksed','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1519'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1519','Muud nхuded tццtajate vastu','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1521'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				" values ('1519','Nхuded riigieelarvele liigendamata tulude osas ','KONTOD',"+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1522'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1522','Nхuded riigieelarvele majandustegevusest teenitud tulude (omatulud) osas ','KONTOD',"+;
				str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1523'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1523','Nхuded riigieelarvele sihtfinantseerimise osas  ','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1528'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1528','Laekumised riigieelarvesse (majandustegevusest, sihtfinantseerimisest)','KONTOD', "+;
				str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1529'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1529','Tasumised riigieelarvest (majandustegevusest, sihtfinantseerimisest)','KONTOD',"+;
				str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '1653'
		If found ()
			cString = "Update library set nimetus = 'Ettemakstud tootuskindlustuse maks' where id = "+str(qryKnt.id)
		Else
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('1653','Ettemakstud tццtuskindlustuse maks','KONTOD', "+str(grekv)+")"
		Endif
&&		lError = sqlsetprop(gnhandle,'BatchMode',.t.)
		lError = sqlexec (gnhandle,cString)
		If lError < 0
			Return .f.
		Endif
&&		lError = sqlsetprop(gnhandle,'BatchMode',.t.)
		Select qryKnt
		Locate for kood = '599'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('599','Siirded eelarvesse ','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '5991'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				" values ('5991','Kulud siiretest eelarvesse','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '6062'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('6062','Valitavate ja nimetatavate ametnike lisatasu','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '6063'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('6063','Valitavate ja nimetatavate ametnike esindustasu','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '7286'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('7286','Vддrtpaberituru kutseliste osaliste, krediidiasutuste, kindlustusandjate ja "+;
				"-vahendajate, fondivalitsejate ja investeerimisfondidega seotud toimingute riigilхiv','KONTOD',"+;
				str( grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '7287'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				" values ('7287','Valla- ja linnaeelarvesse kauplemisloa vдljastamise eest laekuv riigilхiv ','KONTOD', "+;
				str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
		Select qryKnt
		Locate for kood = '7288'
		If !found ()
			cString = "Insert into library (kood, nimetus, library, rekvid) "+;
				"values ('7288','Valla- ja linnaeelarvesse ehituslubade, kasutuslubade ja riikliku "+;
				"ehitusregistri andmete kinnitatud vдljavotete eest laekuv riigilхiv','KONTOD', "+str(grekv)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 0
				Return .f.
			Endif
		Endif
&&		lError = sqlsetprop(gnhandle,'BatchMode',.t.)
		cString = "select rekv.id as rekvid, library.kood, library.id from rekv,library "+;
			"where library.id not in (select distinct parentid from kontoinf  )" +;
			" and library.library = 'KONTOD' "+;
			" order by rekv.id"
		lError = sqlexec (gnhandle,cString,'qryKontoinf')
		If lError < 0
			Return .f.
		Endif
&&		lError = sqlsetprop(gnhandle,'BatchMode',.f.)
		Select qryKontoinf
		Scan
			cString = " insert into kontoinf (parentid, type, formula, aasta, algsaldo, liik, rekvid) values ("+;
				str(qryKontoinf.id)+",1,0,2003,0,1,"+str(qryKontoinf.rekvid)+")"
			lError = sqlexec (gnhandle,cString)
			If lError < 1
				Exit
			Endif
		Endscan
		If lError < 1
&&			lError = sqlsetprop(gnhandle,'BatchMode',.t.)
			Return .f.
		Endif
	Endif


	Return lError
Endproc
