drop table if exists import; 

create table import (jrk text, regkood text, nimetus text,Volg1 text, Ettemaks1 text, Intress1 text,  Volg2 text, Ettemaks2 text,  Intress2 text, Volg3 text, Ettemaks3 text, Intress3 text);

INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('1', '12006189', '1Credit Narva', '0.00', '0.00', NULL, NULL, '-23.04', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('2', '10451293', 'A&G Kaubanduse ', '0.00', '0.00', NULL, NULL, '288', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('3', '46508113728', 'AIDA SOLOVTSOVA  ', '0.00', '1.25', NULL, NULL, '5.93', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('4', '12173303', 'Aikomus-Eesti ', '0.00', '0.00', NULL, '56.64', '28.32', NULL, '-56.64', '-0.17', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('5', '10152219', 'Aknamaailm', '0.00', '0.00', NULL, '0', '3.75', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('6', '10034715', 'Alexela Oil ', '0.00', '36.40', NULL, '23.4', '-44.2', NULL, '-23.40', '-80.60', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('7', '11521724', 'ART DEPOO OÜ  ', '1242.60', '0.00', NULL, '1242.6', '2801.66', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('8', '10227532', 'ASTRI-NARVA ', '0.00', '0.00', NULL, '0', '-134.4', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('9', '11335258', 'AUTOMAISTRO ', '0.00', '0.00', NULL, NULL, '-9.6', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('10', '10090458', 'BALTIC BOLT ', '0.00', '9.60', NULL, NULL, '28.8', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('11', '11902237', 'Baltika7Grupp', '0.00', '0.00', NULL, '-77.27', '380.96', '5.64', '77.27', '0.00', '-5.64');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('12', '10099637', 'BALTMANN ', '135.42', '0.00', NULL, NULL, '80.34', NULL, '135.42', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('13', '12386039', 'Butterfly Media ', '0.00', '0.00', NULL, '17.66', NULL, NULL, '-17.66', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('16', '11488826', 'Danske Bank AS Eesti filiaal ', '0.00', '553.97', NULL, NULL, '287.1', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('19', '10132027', 'Ekstranar', '0.00', '0.00', NULL, NULL, '-3.75', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('20', '10081778', 'E.T.V.A. Varuosad', '0.00', '0.00', NULL, '-23.04', '46.48', NULL, '23.04', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('21', '10283074', 'Elion Ettevotted. ', '0.00', '0.00', NULL, '0', '408', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('22', '10096159', 'EMT ', '0.00', '504.00', NULL, '-46.25', '529.75', NULL, '46.25', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('24', '12123989', 'Fidera Baltic', '0.00', '0.00', NULL, NULL, '3.75', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('25', '10669454', 'Hydroscand', '0.00', '42.24', NULL, NULL, '63.36', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('29', '10348263', 'JCDecaux Eesti ', '0.00', '0.00', NULL, '510.19', '405.01', NULL, '-510.19', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('30', '12032436', 'Juventa Tuur Reisiburoo ', '0.00', '0.00', NULL, NULL, '1.25', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('31', '10170660', 'JYSK Linnen`n Furniture  ', '141.84', '0.00', NULL, '357.84', '216', NULL, '-72.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('34', '46908213724', 'Ljudmila Susarova', '0.00', '0.00', NULL, NULL, '4.48', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('36', '11188998', 'Kristi Mööbel', '0.00', '0.00', NULL, '43.2', NULL, NULL, '-43.20', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('37', '10895280', 'LORITA REISIBUROO', '0.00', '0.00', NULL, '11.52', '-23.04', NULL, '-11.52', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('38', '10196524', 'M-NAR Kinnisvara. ', '0.00', '0.00', NULL, NULL, '230.4', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('42', '10013788', 'NAKRO', '0.00', '28.80', NULL, NULL, '-55.43', NULL, '0.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('45', '12430036', 'NARVA TULETORJEUHING  ', '0.00', '0.00', NULL, '12.8', NULL, NULL, '-12.80', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('46', '11292916', 'Narva Votmed', '0.00', '5.00', NULL, '1.25', '14', NULL, '-1.25', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('47', '10228767', 'Narva-Joesuu Sanatoorium  ', '10.50', '0.00', NULL, '130.5', '-48', NULL, '-120.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('48', '10167511', 'NESTE EESTI ', '0.00', '0.00', NULL, '78', '41.6', NULL, '-78.00', '39.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('50', '10115230', 'ONOFF Eesti', '0.00', '0.00', NULL, '1.8', NULL, NULL, '-1.80', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('52', '11269030', 'Optimera Estonia.  ', '0.00', '0.00', NULL, '211.2', '211.3', NULL, '-211.20', '-211.30', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('53', '10633551', 'Oseeniks Grupp', '0.00', '21.76', NULL, '4.48', '39.68', '1.06', '-4.48', '-17.92', '-1.06');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('54', '12542781', 'PGSTYLER.  ', '0.00', '5.00', NULL, '1.25', '5', NULL, '-1.25', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('55', '10190065', 'Premier Restaurants Eesti  ', '182.40', '0.00', NULL, '86.4', '578.54', NULL, '96.00', '-578.54', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('56', '10569681', 'Prisma Peremarket', '0.00', '656.00', NULL, '737.98', NULL, NULL, '-737.98', '656.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('57', '80145868', 'Rahu 18/3', '0.00', '6.40', NULL, '1.6', '6.4', NULL, '-1.60', '-1.60', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('58', '10896894', 'RARITAS ', '0.00', '9.50', NULL, '9.6', '9.52', NULL, '-9.60', '-9.62', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('60', '10263574', 'Rimi Eesti Food', '0.00', '2354.00', NULL, '490.52', '2392.4', NULL, '-490.52', '-38.40', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('61', '10379733', 'Selver', '0.00', '0.00', NULL, '368', '0', NULL, '-368.00', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('63', '11088541', 'Shinok', '0.00', '0.00', NULL, '-4.06', NULL, NULL, '4.06', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('64', '10180925', 'Statoil Fuel&Retail Eesti ', '0.00', '537.60', NULL, '134.4', '605.62', NULL, '-134.40', '-68.02', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('65', '11404108', 'Stereo Media', '0.00', '0.00', NULL, '0', '111.76', NULL, '0.00', '-111.76', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('66', '10060701', 'Swedbank', '0.00', '0.00', NULL, '0', '142.2', NULL, '0.00', '-142.20', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('67', '45608152226', 'TATIANA LVOVA ', '0.00', '12.50', NULL, '1.25', '7.67', NULL, '-1.25', '4.83', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('68', '10330885', 'TOODE', '0.00', '9.60', NULL, '2.4', '9.6', NULL, '-2.40', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('69', '80335973', 'Tootmise Äriinkubaator Noorus  ', '282.24', '22.81', '22.81', '310.81', '22.81', '22.81', '-22.81', '-22.81', '-22.81');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('70', '10133162', 'Veelma Arvi', '0.00', '0.00', NULL, '0', '3.75', NULL, '0.00', '-3.75', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('71', '10246995', 'Veera ZILTSOVA VELEN', '0.00', '1.25', NULL, '1.25', '1.25', NULL, '-1.25', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('72', '10020239', 'VILDE ', '0.00', '134.40', NULL, '33.6', '134.4', NULL, '-33.60', '0.00', '0.00');
INSERT INTO import (jrk, regkood, nimetus, volg1, ettemaks1, intress1, volg2, ettemaks2, intress2, volg3, ettemaks3, intress3) VALUES ('73', '10873580', 'VILLIAUTO ', '0.00', '0.00', NULL, '1.25', '9.5', NULL, '-1.25', '-9.50', '0.00');

CREATE OR REPLACE FUNCTION import()
  RETURNS numeric AS
$BODY$

DECLARE 
	v_rec record;
	l_asutus_id integer;
	l_luba_id integer;
	l_dok_id integer;
	lnCount integer = 0;
begin	
	for v_rec in
		select volg3, ettemaks3, intress3, regkood, nimetus from import 
			where regkood is not null and regkood not ilike '%reg.nr%'
	loop
		raise notice 'v_rec.regkood %, v_rec.nimetus %, v_rec.volg3 %, v_rec.ettemaks3 %',  v_rec.regkood, v_rec.nimetus, v_rec.volg3, v_rec.ettemaks3;
		-- otsime asutus
		select id into l_asutus_id from asutus where regkood = v_rec.regkood;
		if l_asutus_id  is null then
			raise notice 'Asutus puudub v_rec.regkood %', v_rec.regkood;
			exit;
		end if;
		-- otsime luba
		select id into l_luba_id from luba where parentId = l_asutus_id and staatus > 0 order by id desc limit 1;
		-- koostame parandus
		if l_luba_id is null then
			raise notice 'Luba puudub v_rec.regkood %', v_rec.regkood;
			exit;
		end if;
		if v_rec.volg3::numeric <> 0 then
			l_dok_id =  sp_salvesta_toiming(0, l_asutus_id, l_luba_id, date(2014,09,30), 'PARANDUS', '', date(2014,09,30), v_rec.volg3::numeric, 1, 'PARANDUS', '', 0, 0, 1, 'EUR', 1, null);
			raise notice 'koostame parandus l_dok_id %', l_dok_id;
			lnCount = lnCount + 1;
		end if;
		-- koostame intress
		if v_rec.intress3::numeric <> 0 then
			l_dok_id =  sp_salvesta_toiming(0, l_asutus_id, l_luba_id, date(2014,09,30), 'INTRESS', '', date(2014,09,30), v_rec.intress3::numeric, 1, 'INTRESS', '', 0, 0, 1, 'EUR', 1, null);
			raise notice 'koostame intress l_dok_id %', l_dok_id;
			lnCount = lnCount + 1;
		end if;
		
		-- koostame ettemaks
		if v_rec.ettemaks3::numeric <> 0 then
			insert into ettemaksud (rekvid, asutusid, dokid, doktyyp, kpv, summa, number, selg, muud, journalid) 
				values (28, l_asutus_id, 0, 1, date(2014,09,30), v_rec.ettemaks3::numeric, 0, 'Parandus', '', 0);
			lnCount = lnCount + 1;
		end if;
		
		
	end loop;
	return lnCount;
end;
$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;


select import();


drop function if exists import();

drop table if exists import;
